<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G·ª≠i Trao NƒÉm M·ªõi 2026</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;1,400&family=Dancing+Script:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* --- GLOBAL RESET & FONTS --- */
        :root {
            --bg-night: #0a0a0a;
            --text-gold: #ffbd69;
            --accent-red: #8a2323;
            --fire-glow: rgba(255, 120, 0, 0.6);
            --paper-bg: #fdfaf1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background-color: var(--bg-night);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            overscroll-behavior: none;
        }

        /* --- BACKGROUND SAO & SAO BƒÇNG --- */
        #star-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
        }

        #meteor-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
            opacity: var(--opacity);
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
            }
        }

        /* --- LOGIC CHUY·ªÇN TRANG --- */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            z-index: 10;
            padding: 20px;
        }

        .page.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .page-exit {
            animation: pageZoomOut 0.8s forwards ease-in;
            pointer-events: none;
        }

        .page-enter {
            display: flex;
            animation: pageZoomIn 1s forwards ease-out;
            pointer-events: auto;
        }

        @keyframes pageZoomOut {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }

            100% {
                opacity: 0;
                transform: scale(1.2);
                filter: blur(10px);
            }
        }

        @keyframes pageZoomIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
                filter: blur(10px);
            }

            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
        }

        /* --- STYLE CHO N√öT B·∫§M (RESPONSIVE) --- */
        .btn-general {
            margin-top: 20px;
            padding: 12px 30px;
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Dancing Script', cursive;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            transition: 0.3s;
            touch-action: manipulation;
        }

        .btn-general:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* --- PAGE 1: NH·∫¨P T√äN --- */
        #page-1 input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #fff;
            color: var(--text-gold);
            font-family: 'Dancing Script', cursive;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            text-align: center;
            outline: none;
            padding: 10px;
            width: 100%;
            max-width: 300px;
        }

        #page-1 h2 {
            font-weight: normal;
            margin-bottom: 20px;
            font-size: clamp(1rem, 4vw, 1.5rem);
            opacity: 0.8;
            text-align: center;
        }

        /* --- PAGE 2: THI·ªÜP --- */
        .letter-container {
            background: var(--paper-bg);
            color: #2c3e50;
            padding: 40px 30px;
            border-radius: 2px;
            width: 100%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), inset 0 0 50px rgba(0, 0, 0, 0.05);
            position: relative;
            transform: rotate(-1deg);
            animation: slideIn 1.2s ease-out forwards;
        }

        .letter-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            border-width: 0 40px 40px 0;
            border-style: solid;
            border-color: #ddd var(--bg-night) #ddd #ddd;
            display: block;
            width: 0;
        }

        .letter-container h1 {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            color: var(--accent-red);
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(138, 35, 35, 0.2);
            padding-bottom: 10px;
        }

        .letter-content {
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            line-height: 1.6;
            min-height: 150px;
            text-align: left;
            font-style: italic;
        }

        .letter-footer {
            margin-top: 20px;
            text-align: right;
            font-family: 'Dancing Script', cursive;
            font-size: clamp(1.1rem, 4vw, 1.3rem);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(50px) rotate(-3deg);
            }

            to {
                opacity: 1;
                transform: translateY(0) rotate(-1deg);
            }
        }

        /* --- PAGE 3: CHOICE (ƒê√É ·∫®N) --- */
        /* Gi·ªØ l·∫°i style nh∆∞ng kh√¥ng d√πng t·ªõi */
        .card {
            width: 90%;
            max-width: 600px;
            padding: 30px 20px !important;
        }

        /* --- PAGE 3: INTERACTIVE (SCROLLABLE) --- */
        #page-3-interactive {
            display: none;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: var(--bg-night);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            -webkit-overflow-scrolling: touch;
        }

        .interactive-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 100;
            padding-bottom: 100px;
        }

        .interactive-section {
            min-height: 90vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s, transform 1s;
            padding: 20px 0;
        }

        .interactive-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .interactive-title {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(2rem, 6vw, 3rem);
            margin-bottom: 20px;
            color: var(--text-gold);
            text-shadow: 0 0 10px var(--fire-glow);
            text-align: center;
        }

        /* --- Element: N·ªìi B√°nh Ch∆∞ng --- */
        .pot-container {
            position: relative;
            width: 120px;
            height: 100px;
            background: #3e2723;
            border-radius: 10px 10px 40px 40px;
            margin: 40px auto;
            box-shadow: 0 0 50px var(--fire-glow);
            animation: flicker 3s infinite alternate;
            transform-origin: center;
        }

        @media (max-width: 400px) {
            .pot-container {
                transform: scale(0.8);
                margin: 30px auto;
            }
        }

        .pot-lid {
            width: 130px;
            height: 20px;
            background: #5d4037;
            position: absolute;
            top: -10px;
            left: -5px;
            border-radius: 5px;
            animation: rumble 0.5s infinite;
        }

        .steam {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Dancing Script', cursive;
            font-size: 1.2rem;
            white-space: nowrap;
            animation: steamUpNatural 4s ease-out forwards;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        /* --- Element: ƒê√®n D·∫ßu --- */
        .lamp {
            width: 40px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50% 50% 10% 10%;
            position: relative;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .flame {
            width: 14px;
            height: 30px;
            background: linear-gradient(to top, orangered, orange, yellow);
            border-radius: 50% 50% 20% 20%;
            position: absolute;
            bottom: 5px;
            box-shadow: 0 0 15px orange;
            opacity: 0.8;
            animation: flickerSmall 0.2s infinite alternate;
            transform-origin: bottom center;
            transition: all 0.5s;
        }

        .flame.flare-up {
            animation: flameBurst 2s forwards;
        }

        .wish-input-wrapper {
            position: relative;
            width: 90%;
            max-width: 400px;
            margin: 0 auto;
            height: 50px;
        }

        .wish-input,
        textarea {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid #777;
            color: inherit;
            text-align: center;
            padding: 10px;
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            outline: none;
            display: block;
        }

        textarea {
            font-family: 'Lora', serif;
            font-size: 1rem;
            width: 90%;
            max-width: 400px;
            resize: none;
            margin: 0 auto;
            display: block;
        }

        .ash-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            text-align: center;
            pointer-events: none;
            display: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .turn-to-ash {
            animation: ashDissolve 3s forwards ease-in-out;
            display: block !important;
        }

        /* --- Element: C·ª≠a s·ªï --- */
        .window-frame {
            width: 80vw;
            max-width: 300px;
            height: 50vh;
            max-height: 400px;
            border: 8px solid #3e2723;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            margin: 0 auto;
        }

        #window-meteor-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* --- Element: L√¨ x√¨ --- */
        .envelope {
            width: 120px;
            height: 180px;
            background: var(--accent-red);
            margin: 30px auto;
            position: relative;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.5s;
        }

        .envelope::after {
            content: 'üßß';
            font-size: 2rem;
        }

        .lucky-note {
            display: none;
            background: #fff5e6;
            color: #8a2323;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 400px;
            margin: 20px auto;
            font-family: 'Dancing Script', cursive;
            font-size: 1.3rem;
            animation: unfold 1s ease;
            text-align: center;
        }

        /* --- KEYFRAMES --- */
        @keyframes steamUpNatural {
            0% {
                top: -20px;
                opacity: 0;
                transform: translateX(-50%) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translateX(-55%) scale(1);
            }

            50% {
                transform: translateX(-45%) scale(1.1);
            }

            100% {
                top: -150px;
                opacity: 0;
                transform: translateX(-50%) scale(1.5);
                filter: blur(2px);
            }
        }

        @keyframes flicker {
            0% {
                opacity: 0.8;
                transform: scale(1);
            }

            100% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        @keyframes flickerSmall {
            0% {
                opacity: 0.7;
                transform: scale(0.8);
            }

            100% {
                opacity: 0.9;
                transform: scale(0.9);
            }
        }

        @keyframes rumble {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(1deg);
            }

            75% {
                transform: rotate(-1deg);
            }
        }

        @keyframes unfold {
            from {
                transform: scaleY(0);
            }

            to {
                transform: scaleY(1);
            }
        }

        @keyframes flameBurst {
            0% {
                transform: scale(0.9);
                filter: brightness(1);
            }

            20% {
                transform: scale(1.6);
                filter: brightness(1.5);
                box-shadow: 0 0 60px orangered;
            }

            80% {
                transform: scale(1.4);
                filter: brightness(1.2);
            }

            100% {
                transform: scale(0.9);
                filter: brightness(1);
            }
        }

        @keyframes ashDissolve {
            0% {
                color: #fff;
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            30% {
                color: #333;
                text-shadow: 0 0 15px orangered;
                transform: translateY(-20px) scale(1.1);
            }

            60% {
                color: #888;
                text-shadow: none;
                filter: blur(4px);
                letter-spacing: 5px;
                opacity: 0.5;
            }

            100% {
                color: transparent;
                transform: translateY(-150px) scale(1.5);
                filter: blur(15px);
                letter-spacing: 20px;
                opacity: 0;
            }
        }

        /* --- PAGE 4: FINALE --- */
        #happy-new-year {
            position: absolute;
            top: 40%;
            left: 0;
            width: 100%;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 3s ease;
            z-index: 200;
            padding: 0 10px;
        }

        #happy-new-year h1 {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(2.5rem, 8vw, 5rem);
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 1), 0 0 60px #ffbd69;
            line-height: 1.2;
        }

        #happy-new-year p {
            font-size: clamp(1rem, 4vw, 1.5rem);
            margin-top: 10px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #fireworksCanvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        @media (max-width: 600px) {
            .letter-container {
                padding: 30px 20px;
                width: 95%;
            }

            .btn-general {
                margin-top: 25px;
            }
        }
    </style>
</head>

<body>
    <audio id="bg-music" src="snaptik.vn_MKmpp.mp4 2.mp3" loop></audio>
    <div id="star-bg"></div>
    <canvas id="meteor-canvas"></canvas>

    <div id="page-1" class="page active">
        <h2>Ch√†o b·∫°n, t√™n b·∫°n l√† g√¨ n√®?</h2>
        <input type="text" id="name-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." autocomplete="off">
        <button class="btn-general" onclick="goToPage2()">Ti·∫øp t·ª•c</button>
    </div>

    <div id="page-2" class="page">
        <div class="letter-container">
            <h1>G·ª≠i <span id="display-name">...</span>,</h1>
            <div id="typewriter-text" class="letter-content"></div>
            <div class="letter-footer" id="letter-footer" style="opacity: 0; transition: 1s;">
                K√Ω t√™n: Tui n√® (G·ª≠i t·ª´ 2026)
            </div>
            <p id="wait-message"
                style="display:none; text-align: center; font-size: 0.9rem; margin-top: 25px; color: #888; font-style: italic; font-family: 'Lora', serif;">
                ƒê·ª£i 1 x√≠u nh√©...
            </p>
        </div>
    </div>

    <div id="page-3-choice" class="page" style="display:none !important;"></div>

    <div id="page-3-interactive">
        <div class="interactive-container">
            <section class="interactive-section visible">
                <h2 class="interactive-title">B·∫øp l·ª≠a nƒÉm m·ªõi</h2>
                <div class="pot-container">
                    <div class="pot-lid"></div>
                    <div id="steam-container"></div>
                </div>
                <p style="text-align: center; color: #e6dace; padding: 0 10px;">B√™n n·ªìi b√°nh ch∆∞ng ƒëang s√¥i, nh·ªØng mong
                    c·∫ßu ƒëang bay l√™n.</p>
            </section>

            <section class="interactive-section">
                <h2 class="interactive-title">G·ª≠i L·∫°i NƒÉm C≈©</h2>
                <div class="lamp">
                    <div class="flame" id="lamp-flame"></div>
                </div>
                <div class="wish-input-wrapper">
                    <input type="text" class="wish-input" id="wish-input-old"
                        placeholder="M·ªôt n·ªói bu·ªìn mu·ªën bu√¥ng b·ªè..." autocomplete="off">
                    <div id="ash-display" class="ash-text"></div>
                </div>
                <button class="btn-general" onclick="lightLamp()" style="display: block; margin: 20px auto;">Th·∫Øp ƒë√®n &
                    H√≥a gi·∫£i</button>
            </section>

            <section class="interactive-section">
                <h2 class="interactive-title">Khung C·ª≠a Nguy·ªán C·∫ßu</h2>
                <div class="window-frame" id="window-frame">
                    <div id="stars-layer-window" style="width:100%; height:100%;"></div>
                    <canvas id="window-meteor-canvas"></canvas>
                </div>
                <textarea id="reflection-input" rows="1" placeholder="G·ª≠i v√†o ƒë√¢y m·ªôt hy v·ªçng..."
                    style="margin-top:20px; color: #e6dace;"></textarea>
                <button class="btn-general" onclick="sendWish()" style="display: block; margin: 20px auto;">G·ª≠i ni·ªÅm hy
                    v·ªçng</button>
                <p id="window-feedback"
                    style="text-align:center; font-size: 0.8rem; margin-top: 10px; opacity: 0; transition: opacity 1s;">
                    V≈© tr·ª• ƒë√£ l·∫Øng nghe.</p>
            </section>

            <section class="interactive-section">
                <h2 class="interactive-title">L·ªôc ƒê·∫ßu NƒÉm</h2>
                <p style="text-align: center; color: #e6dace; padding: 0 10px;">Kh√¥ng ph·∫£i ti·ªÅn b·∫°c. ƒê√¢y l√† ch√∫t v·ªën
                    li·∫øng tinh th·∫ßn cho b·∫°n.</p>
                <div class="envelope" onclick="openEnvelope()"></div>
                <div id="lucky-note" class="lucky-note"></div>
            </section>

            <section class="interactive-section">
                <h2 class="interactive-title">C√πng nhau ng·∫Øm ph√°o hoa nh√©</h2>
                <p style="text-align: center; color: #e6dace; padding: 0 10px;">Th·ªùi kh·∫Øc r·ª±c r·ª° nh·∫•t ƒë√£ ƒë·∫øn r·ªìi.</p>
                <button class="btn-general" onclick="goToPage4()">B·∫Øt ƒë·∫ßu th√¥i n√†o</button>
            </section>
        </div>
    </div>

    <div id="page-4" class="page">
        <canvas id="fireworksCanvas"></canvas>
        <div id="happy-new-year">
            <h1>Happy New Year 2026</h1>
            <p>R·ª±c r·ª° - B√¨nh An - H·∫°nh Ph√∫c</p>
        </div>
    </div>

    <script>
        // --- GLOBAL MUSIC ---
        const bgMusic = document.getElementById('bg-music');
        let musicStarted = false;

        async function startMusicOnce() {
            if (musicStarted) return;
            bgMusic.volume = 0.6;
            bgMusic.play().catch(() => { });
            try {
                if ('wakeLock' in navigator) {
                    await navigator.wakeLock.request('screen');
                }
            } catch (err) { }
            musicStarted = true;
            document.removeEventListener('click', startMusicOnce);
            document.removeEventListener('touchstart', startMusicOnce);
        }

        document.addEventListener('click', startMusicOnce);
        document.addEventListener('touchstart', startMusicOnce);

        // --- 1. SETUP CHUNG ---
        function createStars() {
            const bg = document.getElementById('star-bg');
            for (let i = 0; i < 100; i++) {
                const s = document.createElement('div');
                s.className = 'star';
                const size = Math.random() * 2 + 1;
                s.style.width = size + 'px';
                s.style.height = size + 'px';
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                s.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                s.style.setProperty('--opacity', Math.random());
                bg.appendChild(s);
            }
        }
        createStars();

        // --- ENGINE SAO BƒÇNG ---
        class MeteorEngine {
            constructor(canvasId, isWindow = false) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.meteors = [];
                this.width = 0;
                this.height = 0;
                this.isWindow = isWindow;
                this.resize();
                if (!isWindow) {
                    window.addEventListener('resize', () => this.resize());
                } else {
                    window.addEventListener('resize', () => this.resizeWindowFrame());
                    this.resizeWindowFrame();
                }
                this.animate();
            }

            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
            }

            resizeWindowFrame() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.width = rect.width;
                this.height = rect.height;
                this.canvas.width = this.width;
                this.canvas.height = this.height;
            }

            shoot(forced = false) {
                let chance = this.isWindow ? 0.01 : 0.02;
                if (!forced && Math.random() > chance) return;
                this.meteors.push(new Meteor(this.width, this.height, this.isWindow));
            }

            animate() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.shoot();
                for (let i = 0; i < this.meteors.length; i++) {
                    this.meteors[i].update();
                    this.meteors[i].draw(this.ctx);
                    if (this.meteors[i].isDead()) {
                        this.meteors.splice(i, 1);
                        i--;
                    }
                }
                requestAnimationFrame(() => this.animate());
            }
        }

        class Meteor {
            constructor(w, h, isWindow) {
                this.isWindow = isWindow;
                if (isWindow) {
                    this.x = Math.random() * w;
                    this.y = Math.random() * (h * 0.4);
                    this.len = Math.random() * 40 + 30;
                    this.speed = Math.random() * 2 + 5;
                    this.size = Math.random() + 0.5;
                } else {
                    this.x = Math.random() * w;
                    this.y = Math.random() * h * 0.5;
                    this.len = Math.random() * 200 + 100;
                    this.speed = Math.random() * 10 + 20;
                    this.size = Math.random() * 2 + 0.5;
                }
                this.angle = Math.PI / 4 + (Math.random() * 0.2 - 0.1);
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.opacity = 1;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.opacity -= 0.015;
            }
            draw(ctx) {
                const tailX = this.x - Math.cos(this.angle) * this.len;
                const tailY = this.y - Math.sin(this.angle) * this.len;
                const gradient = ctx.createLinearGradient(this.x, this.y, tailX, tailY);
                gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
                gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(tailX, tailY);
                ctx.lineWidth = this.size;
                ctx.lineCap = 'round';
                ctx.strokeStyle = gradient;
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                ctx.shadowBlur = 5;
                ctx.shadowColor = "white";
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            isDead() { return this.opacity <= 0; }
        }

        const bgMeteorEngine = new MeteorEngine('meteor-canvas');

        // --- 2. LOGIC CHUY·ªÇN TRANG & B·ª®C TH∆Ø ---
        const wishesList = [
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t vui v·∫ª, h·∫°nh ph√∫c v√† b√¨nh an n√®ee. NƒÉm c·ªßa c·∫≠u ƒë√≥, b∆∞·ªõc v√†o nƒÉm m·ªõi v·ªõi kh√≠ th·∫ø b√πng n·ªï nh∆∞ nh√¢n v·∫≠t ch√≠nh thanh xu√¢n, v√¥ ph√≤ng thi b·∫≠t mode chi·∫øn th·∫ßn v√† ƒë·ª£i tin ƒë·∫≠u Nguy·ªán v·ªçng 1 th√¥i.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 lu√¥n tr√†n ƒë·∫ßy ni·ªÅm vui, h·∫°nh ph√∫c v√† b√¨nh an trong t·ª´ng ng√†y. Thi c·ª≠ nƒÉm nay nh·∫π t√™nh nh∆∞ m√¢y bay, n√£o ch·∫°y m∆∞·ª£t nh∆∞ wifi full v·∫°ch, khoanh c√¢u n√†o ch·∫Øc c√¢u ƒë√≥ v√† Nguy·ªán v·ªçng 1 ch·ªâ c√≤n l√† th·ªß t·ª•c.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t r·ª±c r·ª°, h·∫°nh ph√∫c v√† b√¨nh an h·∫øt n·∫•c. ƒêi thi t√¢m th·∫ø chill nh∆∞ng l√†m b√†i c·ª±c g·∫Øt, ƒëi·ªÉm cao ch√≥t v√≥t v√† Nguy·ªán v·ªçng 1 g·ªçi t√™n c√°i r·ª•p nghe m√† ƒë√£.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 lu√¥n an y√™n, vui v·∫ª v√† ng·∫≠p tr√†n ti·∫øng c∆∞·ªùi. Gi·ªØ b√¨nh tƒ©nh gi·ªØa ph√≤ng thi ƒë√¥ng ng∆∞·ªùi, th√™m ch√∫t t·ª± tin l√† v√© Nguy·ªán v·ªçng 1 n·∫±m g·ªçn trong tay li·ªÅn.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 h·∫°nh ph√∫c ƒë·ªß ƒë·∫ßy v√† b√¨nh an trong m·ªçi kho·∫£nh kh·∫Øc. Thi xong t·ª± tin t√°m ph·∫ßn, xem ƒëi·ªÉm ƒë·ªß m∆∞·ªùi ph·∫ßn v√¨ ƒë√£ ƒë·∫≠u Nguy·ªán v·ªçng 1 th·∫≠t s·ª±.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t vui, th·∫≠t ·∫•m √°p v√† b√¨nh an d√†i d√†i. H·ªçc v√†o nh∆∞ n∆∞·ªõc ƒë·ªï ly ƒë·∫ßy ·∫Øp, v√†o ph√≤ng thi bung h·∫øt skill v√† rinh lu√¥n su·∫•t Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng t√≠ch c·ª±c, h·∫°nh ph√∫c v√† b√¨nh an m·ªói s√°ng th·ª©c d·∫≠y. B·∫£n lƒ©nh h∆°n m·ªçi √°p l·ª±c v√† hi√™n ngang b∆∞·ªõc t·ªõi Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 lu√¥n m·ªâm c∆∞·ªùi, h·∫°nh ph√∫c v√† an nhi√™n gi·ªØa b·ªôn b·ªÅ. L√†m b√†i tr∆°n tru t·ª´ c√¢u ƒë·∫ßu t·ªõi c√¢u cu·ªëi v√† ƒë·∫≠u Nguy·ªán v·ªçng 1 trong s·ª± h√¢n hoan.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t nhi·ªÅu ni·ªÅm vui, h·∫°nh ph√∫c v√† b√¨nh an trong tim. G·∫∑p ƒë√∫ng t·ªß th√¨ vui h·∫øt n·∫•c, g·∫∑p ngo√†i t·ªß v·∫´n x·ª≠ ƒë·∫πp v√† ti·∫øn th·∫≥ng t·ªõi Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 r·ªôn r√†ng ti·∫øng c∆∞·ªùi, h·∫°nh ph√∫c ƒë·ªß ƒë·∫ßy v√† b√¨nh an v·ªØng ch·∫Øc. Gi·ªØ ƒë·∫ßu l·∫°nh tim n√≥ng, l√†m b√†i xong nh·∫π t√™nh v√¨ bi·∫øt Nguy·ªán v·ªçng 1 trong t·∫ßm v·ªõi.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t vui v·∫ª, h·∫°nh ph√∫c v√† b√¨nh an nhaaa. C·ªë th√™m x√≠u n·ªØa l√† ch·∫°m ƒë√≠ch r·ªìi, Nguy·ªán v·ªçng 1 ƒë·ª©ng ƒë√≥ ƒë·ª£i c·∫≠u ch·∫°y c√°i v√®o t·ªõi √¥m li·ªÅn.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 tr√†n ƒë·∫ßy b√¨nh an v√† h·∫°nh ph√∫c m·ªói ng√†y. ƒêi thi feel nh∆∞ l√†m b√†i quen ·ªü nh√†, tay vi·∫øt lia lia v√† combo ƒë·∫≠u Nguy·ªán v·ªçng 1 n·∫±m ch·∫Øc trong t√∫i.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t an y√™n, vui v·∫ª v√† h·∫°nh ph√∫c tr·ªçn v·∫πn. T√¢m l√Ω v·ªØng v√†ng nh∆∞ tr√πm cu·ªëi, s√≥ng gi√≥ c·ª° n√†o c≈©ng kh√¥ng xi nh√™ v√† Nguy·ªán v·ªçng 1 ch·ªâ l√† chuy·ªán s·ªõm mu·ªôn.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t ·∫•m √°p, h·∫°nh ph√∫c v√† b√¨nh an t·ª´ ƒë·∫ßu t·ªõi cu·ªëi nƒÉm. Thi xong ng·ªß m·ªôt gi·∫•c ngon l√†nh v√¨ trong l√≤ng bi·∫øt r√µ m√¨nh ƒë·ªß ƒëi·ªÉm ƒë·∫≠u Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 vui t∆∞∆°i, h·∫°nh ph√∫c v√† b√¨nh an d√†i l√¢u. Coi √°p l·ª±c ch·ªâ l√† t√≠ gia v·ªã v√† m√≥n ch√≠nh nƒÉm nay ch·∫Øc ch·∫Øn l√† ƒë·∫≠u Nguy·ªán v·ªçng 1 cho ƒë√£ c√°i n∆∞.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t nhi·ªÅu ni·ªÅm vui, h·∫°nh ph√∫c v√† b√¨nh an nha. ƒê·ª´ng overthink chi cho m·ªát, l√†m h·∫øt s·ª©c m√¨nh l√† auto ·ªïn √°p v√† Nguy·ªán v·ªçng 1 s·∫Ω v·ªÅ tay.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 r·∫°ng r·ª°, h·∫°nh ph√∫c v√† b√¨nh an m·ªói ng√†y. ƒêi thi tim ƒë·∫≠p v√¨ t·ª± tin ch·ª© kh√¥ng ph·∫£i v√¨ run, k·∫øt qu·∫£ v·ªÅ l√† ƒë·∫≠u Nguy·ªán v·ªçng 1 thuy·∫øt ph·ª•c kh·ªèi b√†n.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 lu√¥n t∆∞∆°i c∆∞·ªùi, h·∫°nh ph√∫c v√† b√¨nh an trong m·ªçi kho·∫£nh kh·∫Øc. Sinh ra l√† ƒë·ªÉ l√†m h·ªçc b√° n√™n Nguy·ªán v·ªçng 1 ch·ªâ l√† c√°i t√™n thoii.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 ƒë·∫ßy ·∫Øp ti·∫øng c∆∞·ªùi, h·∫°nh ph√∫c v√† b√¨nh an ng·∫≠p tr√†n. B∆∞·ªõc v√†o ph√≤ng thi v·ªõi ni·ªÅm tin ƒë·∫ßy t√∫i v√† b∆∞·ªõc ra c·∫ßm ch·∫Øc su·∫•t Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t x·ªãn s√≤, h·∫°nh ph√∫c v√† b√¨nh an su·ªët ch·∫∑ng ƒë∆∞·ªùng. NƒÉm nay l√† nƒÉm b·ª©t ph√° ƒë·ªânh c·ªßa ch√≥p v√† c√°i k·∫øt ƒë·∫πp nh·∫•t v·∫´n l√† ƒë·∫≠u Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t vui v·∫ª, h·∫°nh ph√∫c v√† b√¨nh an n√®ee. ƒê·ªÅ thi nh√¨n c√°i l√† quen nh∆∞ bestie l√¢u ng√†y kh√¥ng g·∫∑p v√† l√†m xong l√† ƒë·ªß ƒëi·ªÉm ƒë·∫≠u Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 tr√†n ƒë·∫ßy h·∫°nh ph√∫c v√† b√¨nh an trong tim. Kh√¥ng c·∫ßn tr√¥ng ch·ªù may m·∫Øn qu√° nhi·ªÅu v√¨ th·ª±c l·ª±c c·∫≠u ƒë·ªânh l·∫Øm r·ªìi, t·ª± tin c√°i l√† ch·∫°m Nguy·ªán v·ªçng 1 c√°i v√®o.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 vui v·∫ª, b√¨nh an v√† h·∫°nh ph√∫c theo ƒë√∫ng k·ªãch b·∫£n x·ªãn s√≤ nh·∫•t. √în b√†i m∆∞·ª£t m√†, l√†m b√†i kh√¥ng tr·∫≠t nh·ªãp v√† k·∫øt phim c√≥ h·∫≠u l√† ƒë·∫≠u Nguy·ªán v·ªçng 1.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t vui v·∫ª, h·∫°nh ph√∫c v√† b√¨nh an trong t·ª´ng ng√†y. ƒê·ªÅ c√≥ khoai ch√∫t c≈©ng kh√¥ng sao, c·∫≠u ƒë·ªß t·ªânh t√°o ƒë·ªÉ x·ª≠ ƒë·∫πp v√† ti·∫øn th·∫≥ng v√¥ ng√¥i tr∆∞·ªùng m∆° ∆∞·ªõc.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t r·ª±c r·ª°, h·∫°nh ph√∫c v√† b√¨nh an nhaaa. Coi ƒëi thi nh∆∞ chuy·∫øn phi√™u l∆∞u ng·∫Øn m√† si√™u √Ω nghƒ©a v√† ƒë·∫≠u Nguy·ªán v·ªçng 1 l√† c·ªôt m·ªëc m·ªü ra c·∫£ b·∫ßu tr·ªùi ph√≠a tr∆∞·ªõc.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 vui v·∫ª, h·∫°nh ph√∫c v√† b√¨nh an tr·ªçn v·∫πn. Nh·ªØng n·ªó l·ª±c √¢m th·∫ßm r·ªìi c≈©ng ƒë∆∞·ª£c ƒë·ªÅn ƒë√°p b·∫±ng m·ªôt su·∫•t v√¥ ng√¥i tr∆∞·ªùng m∆° ∆∞·ªõc nghe m√† ƒë√£ c√°i n∆∞.",
            "Ch√∫c c·∫≠u nƒÉm m·ªõi 2026 th·∫≠t ·∫•m √°p, h·∫°nh ph√∫c v√† b√¨nh an su·ªët nƒÉm d√†i. Ch·ªët l·∫°i h√†nh tr√¨nh b·∫±ng c√∫ finish ƒë·ªânh cao v√† Nguy·ªán v·ªçng 1 ch√≠nh th·ª©c v·ªÅ tay c·∫≠u."
        ];


        let userName = "";

        function typeWriter(text, elementId, speed = 40) {
            let i = 0;
            const element = document.getElementById(elementId);
            element.innerHTML = "";
            function type() {
                if (i < text.length) {
                    let char = text.charAt(i);
                    element.innerHTML += (char === '\n') ? '<br>' : char;
                    i++;
                    setTimeout(type, speed);
                } else {
                    document.getElementById('letter-footer').style.opacity = 1;
                    const waitMsg = document.getElementById('wait-message');
                    waitMsg.style.display = 'block';
                    waitMsg.style.animation = 'twinkle 1s infinite alternate';

                    // --- C·∫¨P NH·∫¨T: T·ª± ƒë·ªông chuy·ªÉn th·∫≥ng t·ªõi Page 3 INTERACTIVE sau 5 gi√¢y ---
                    setTimeout(() => {
                        goToPage3(); // ƒê√£ ƒë∆∞·ª£c s·ª≠a ƒë·ªÉ v√†o th·∫≥ng interactive
                    }, 5000);
                }
            }
            type();
        }

        // --- H√ÄM CHUY·ªÇN TRANG (S·ª¨A ƒê·ªîI) ---
        function switchPage(hideId, showId) {
            const h = document.getElementById(hideId);
            const s = document.getElementById(showId);
            h.classList.add('page-exit');
            h.classList.remove('active');
            setTimeout(() => {
                h.classList.remove('page-exit');
                h.style.display = 'none';

                if (showId === 'page-3-interactive') {
                    s.style.display = 'block';
                    s.classList.add('page-enter');
                    setTimeout(() => s.classList.remove('page-enter'), 1000);
                    s.scrollTop = 0;
                    setTimeout(() => {
                        const sections = document.querySelectorAll('.interactive-section');
                        const observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) entry.target.classList.add('visible');
                            });
                        }, { threshold: 0.1 });
                        sections.forEach(sec => observer.observe(sec));
                    }, 100);
                } else {
                    s.classList.add('active');
                    s.classList.add('page-enter');
                    setTimeout(() => s.classList.remove('page-enter'), 1000);
                }
            }, 800);
        }

        function goToPage2() {
            const input = document.getElementById('name-input');
            if (input.value.trim() === "") {
                alert("H√£y nh·∫≠p t√™n ƒë·ªÉ ch√∫ng m√¨nh x∆∞ng h√¥ nh√©!");
                return;
            }
            userName = input.value;
            document.getElementById('display-name').innerText = userName;
            switchPage('page-1', 'page-2');
            const randomWish = wishesList[Math.floor(Math.random() * wishesList.length)];
            const content = `Ch√†o ${userName}, l√† tui ƒë√¢y.\n\n${randomWish}\n\nB·∫°n c·ªßa tui,`;
            setTimeout(() => {
                typeWriter(content, "typewriter-text", 30);
            }, 1200);
        }

        // --- S·ª¨A ƒê·ªîI: B·ªé QUA PAGE CHOICE, V√ÄO TH·∫≤NG INTERACTIVE ---
        let windowMeteorEngine = null;

        function goToPage3() {
            // Thay v√¨ chuy·ªÉn sang page-3-choice, ta chuy·ªÉn th·∫≥ng sang page-3-interactive
            // v√† g·ªçi c√°c h√†m kh·ªüi t·∫°o c·∫ßn thi·∫øt ngay t·∫°i ƒë√¢y.

            // Logic chuy·ªÉn trang
            switchPage('page-2', 'page-3-interactive');

            // Logic kh·ªüi t·∫°o (l·∫•y t·ª´ startInteractiveMode c≈©)
            setTimeout(() => {
                initSteam();
                initWindowStars();
                if (!windowMeteorEngine) {
                    windowMeteorEngine = new MeteorEngine('window-meteor-canvas', true);
                }
            }, 800);
        }

        function goToPage4() {
            const p3Inter = document.getElementById('page-3-interactive');
            p3Inter.classList.add('page-exit');
            setTimeout(() => {
                p3Inter.style.display = 'none';
                p3Inter.classList.remove('page-exit');
                const p4 = document.getElementById('page-4');
                p4.classList.add('active', 'page-enter');
                setTimeout(() => p4.classList.remove('page-enter'), 1000);
            }, 800);
            setTimeout(startFinale, 1500);
        }

        // --- 3. INTERACTIVE LOGIC ---
        function initSteam() {
            const wishes = ["B√¨nh an", "S·ª©c kh·ªèe", "May m·∫Øn", "H·∫°nh ph√∫c", "Th√†nh c√¥ng", "Ti·ªÅn t√†i", "Vui v·∫ª"];
            const steamCont = document.getElementById('steam-container');
            setInterval(() => {
                if (document.hidden || steamCont.offsetParent === null) return;
                const el = document.createElement('div');
                el.className = 'steam';
                el.innerText = wishes[Math.floor(Math.random() * wishes.length)];
                el.style.left = (50 + (Math.random() * 20 - 10)) + '%';
                steamCont.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }, 2500);
        }

        function lightLamp() {
            const inp = document.getElementById('wish-input-old');
            const ashDisplay = document.getElementById('ash-display');
            const flm = document.getElementById('lamp-flame');
            if (inp && inp.value.trim()) {
                flm.classList.add('flare-up');
                ashDisplay.innerText = inp.value;
                inp.value = "";
                ashDisplay.classList.add('turn-to-ash');
                setTimeout(() => { inp.placeholder = "Mu·ªôn phi·ªÅn ƒë√£ bu√¥ng b·ªè."; }, 800);
                setTimeout(() => { flm.classList.remove('flare-up'); }, 2000);
                setTimeout(() => { ashDisplay.innerText = ""; ashDisplay.classList.remove('turn-to-ash'); }, 3500);
            }
        }

        function initWindowStars() {
            const layer = document.getElementById('stars-layer-window');
            if (layer.children.length > 0) return;
            for (let i = 0; i < 30; i++) {
                const s = document.createElement('div');
                const size = Math.random() * 2 + 1;
                s.style.position = 'absolute';
                s.style.width = size + 'px';
                s.style.height = size + 'px';
                s.style.borderRadius = '50%';
                s.style.background = 'white';
                s.style.opacity = Math.random();
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                s.style.animation = `twinkle ${Math.random() * 3 + 2}s infinite ease-in-out`;
                layer.appendChild(s);
            }
        }

        function sendWish() {
            const fb = document.getElementById('window-feedback');
            const inp = document.getElementById('reflection-input');
            if (inp && inp.value.trim()) {
                inp.value = "";
                inp.placeholder = "ƒê√£ g·ª≠i v√†o v≈© tr·ª•...";
                fb.style.opacity = 1;
                if (windowMeteorEngine) {
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => windowMeteorEngine.shoot(true), i * 300);
                    }
                }
            }
        }

        function openEnvelope() {
            const quotes = ["S·ªëng r·ª±c r·ª° nh√©!", "T√¢m an, v·∫°n s·ª± an.", "M·∫°nh m·∫Ω v√† h·∫°nh ph√∫c.", "Ti·ªÅn ƒë·∫ßy t√∫i, t√¨nh ƒë·∫ßy tim.", "NƒÉm nay s·∫Ω t·ªët h∆°n nƒÉm c≈©.", "Lu√¥n y√™u ƒë·ªùi nh√©!"];
            const note = document.getElementById('lucky-note');
            const env = document.querySelector('.envelope');
            if (note.style.display !== 'block') {
                note.innerText = quotes[Math.floor(Math.random() * quotes.length)];
                note.style.display = 'block';
                env.style.opacity = 0.5;
                env.style.transform = "scale(0.9)";
            }
        }

        // --- 4. FIREWORKS ENGINE (SUPER IMPROVED) ---
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let rockets = [];
        let fireworksActive = false;

        const SystemConfig = {
            tier: 'medium',
            settings: {
                high: { particleCount: { min: 150, max: 250 }, spawnChance: 0.08 },
                medium: { particleCount: { min: 100, max: 180 }, spawnChance: 0.05 },
                low: { particleCount: { min: 50, max: 80 }, spawnChance: 0.03 }
            },
            detect: function () {
                const cores = navigator.hardwareConcurrency || 4;
                const ram = navigator.deviceMemory || 8;
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                let score = cores * 1.5 + ram;
                if (isMobile) score *= 0.6;
                // T·ª± ƒë·ªông ch·ªçn medium cho an to√†n, high n·∫øu m√°y r·∫•t m·∫°nh
                if (score < 6) this.setTier('low');
                else if (score > 12 && !isMobile) this.setTier('high');
                else this.setTier('medium');
            },
            setTier: function (t) { this.tier = t; },
            getCurrent: function () { return this.settings[this.tier]; }
        };
        SystemConfig.detect();

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        const palettes = {
            pureWhite: { base: [255, 255, 255], secondary: [200, 200, 255] },
            gold: { base: [255, 215, 0], secondary: [255, 250, 200] },
            fire: { base: [255, 69, 0], secondary: [255, 165, 0] },
            cool: { base: [0, 191, 255], secondary: [255, 255, 255] },
            spring: { base: [255, 105, 180], secondary: [144, 238, 144] } // Th√™m m√†u xu√¢n
        };

        // --- COMPLEX ALGORITHMS CLASS ---
        class Rocket {
            constructor() {
                this.x = Math.random() * width;
                this.y = height;
                this.destY = Math.random() * (height * 0.4) + height * 0.05;
                this.speed = Math.random() * 5 + 12; // Ch·∫≠m l·∫°i ch√∫t ƒë·ªÉ d·ªÖ nh√¨n
                this.vx = (Math.random() - 0.5) * 3;
                this.vy = -this.speed;
                this.color = '255, 255, 255';
                this.trail = [];
                this.trailMax = 8;
                this.dead = false;
                this.gravity = 0.2;
            }
            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.trail.push({ x: this.x, y: this.y, alpha: 1 });
                if (this.trail.length > this.trailMax) this.trail.shift();
                this.trail.forEach(t => t.alpha -= 0.1);

                if (this.vy >= -1 || this.y <= this.destY) {
                    this.dead = true;
                    createExplosion(this.x, this.y);
                }
            }
            draw() {
                ctx.beginPath();
                for (let i = 0; i < this.trail.length; i++) {
                    const t = this.trail[i];
                    ctx.fillStyle = `rgba(${this.color}, ${t.alpha})`;
                    ctx.fillRect(t.x, t.y, 2, 2);
                }
            }
        }

        class Particle {
            constructor(x, y, v, colorArr) {
                this.x = x;
                this.y = y;
                this.vx = v.x;
                this.vy = v.y;
                this.rgb = colorArr;

                // --- LIFECYCLE ALGORITHM ---
                this.birthTime = Date.now();
                this.lifespan = 2000; // CH√çNH X√ÅC 2 GI√ÇY

                // Physics
                this.friction = 0.96; // Air resistance
                this.gravity = 0.08;
            }
            update() {
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
            }
            draw() {
                const age = Date.now() - this.birthTime;

                // N·∫øu qu√° 2 gi√¢y th√¨ kh√¥ng v·∫Ω n·ªØa (s·∫Ω b·ªã x√≥a ·ªü loop)
                if (age >= this.lifespan) return;

                // T√≠nh to√°n Alpha d·ª±a tr√™n th·ªùi gian (Non-linear fade)
                // Gi·ªØ s√°ng trong 70% th·ªùi gian ƒë·∫ßu, sau ƒë√≥ m·ªù nhanh
                let alpha = 1;
                const progress = age / this.lifespan;

                if (progress > 0.7) {
                    // Map range 0.7 -> 1.0 to alpha 1.0 -> 0.0
                    alpha = 1 - ((progress - 0.7) / 0.3);
                }

                // Flicker effect (nh·∫•p nh√°y ng·∫´u nhi√™n)
                if (Math.random() > 0.9) alpha *= 0.5;

                ctx.fillStyle = `rgba(${this.rgb[0]}, ${this.rgb[1]}, ${this.rgb[2]}, ${alpha})`;
                ctx.fillRect(this.x, this.y, 2, 2);
            }
            isDead() {
                return (Date.now() - this.birthTime) >= this.lifespan;
            }
        }

        function createExplosion(x, y) {
            const conf = SystemConfig.getCurrent();
            const keys = Object.keys(palettes);
            const palette = palettes[keys[Math.floor(Math.random() * keys.length)]];

            // TƒÉng m·∫≠t ƒë·ªô h·∫°t
            const count = Math.floor(Math.random() * (conf.particleCount.max - conf.particleCount.min)) + conf.particleCount.min;

            for (let i = 0; i < count; i++) {
                // Sphere physics
                const angle = Math.random() * Math.PI * 2;
                // Random radius speed
                const speed = Math.random() * 6 + 1;

                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;

                const color = (Math.random() > 0.3) ? palette.base : palette.secondary;
                particles.push(new Particle(x, y, { x: vx, y: vy }, color));
            }

            // Flash effect
            ctx.globalCompositeOperation = 'lighter';
            ctx.fillStyle = `rgba(${palette.base[0]}, ${palette.base[1]}, ${palette.base[2]}, 0.4)`;
            ctx.beginPath();
            ctx.arc(x, y, 60, 0, Math.PI * 2);
            ctx.fill();
        }

        function loop() {
            // Hi·ªáu ·ª©ng m·ªù ƒëu√¥i (Trails)
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = 'rgba(10, 10, 10, 0.15)'; // 0.15 ƒë·ªÉ ƒëu√¥i d√†i v·ª´a ph·∫£i
            ctx.fillRect(0, 0, width, height);
            ctx.globalCompositeOperation = 'lighter';

            const conf = SystemConfig.getCurrent();

            if (fireworksActive && Math.random() < conf.spawnChance) {
                rockets.push(new Rocket());
            }

            for (let i = rockets.length - 1; i >= 0; i--) {
                rockets[i].update();
                rockets[i].draw();
                if (rockets[i].dead) rockets.splice(i, 1);
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].isDead()) {
                    particles.splice(i, 1);
                }
            }
            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

        function startFinale() {
            fireworksActive = true;
            const hny = document.getElementById('happy-new-year');
            hny.style.opacity = 1;
            hny.style.transform = "scale(1.1)";
            // B·∫Øn lo·∫°t ƒë·∫ßu ti√™n
            for (let k = 0; k < 5; k++) setTimeout(() => rockets.push(new Rocket()), k * 200);
        }
    </script>
</body>

</html>